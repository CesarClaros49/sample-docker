pipeline {
  agent {
    kubernetes {
      inheritFrom 'agente-prueba'
    }
  }

  environment {
    REGISTRY = 'clarozzz'
    REPO_BACKEND = 'k8s-backend'
    REPO_FRONTEND = 'k8s-frontend'
    IMAGE_TAG = "${env.BUILD_NUMBER}" // o usa `git rev-parse --short HEAD`
    YAML_REPO = 'https://github.com/CesarClaros49/k8s-manifests.git'
  }

  stages {

    stage('Clone repositories') {
      steps {
        script {
          git 'https://github.com/CesarClaros49/sample-docker'
          
          // Capturar el mensaje del último commit
          env.SAMPLE_COMMIT_MSG = sh(returnStdout: true, script: 'git log -1 --pretty=%s').trim()

          dir('k8s-yamls') {
            git branch: 'main', url: "${YAML_REPO}"
          }
        }
      }
    }

    stage('Login to DockerHub') {
      steps {
        container('docker') {
          withCredentials([usernamePassword(credentialsId: 'docker-hub-creds', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
            sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin'
          }
        }
      }
    }

    stage('Backend - Build & Push') {
      steps {
        dir('backend') {
          container('docker') {
            sh """
              docker build -t $REGISTRY/$REPO_BACKEND:$IMAGE_TAG .
              docker push $REGISTRY/$REPO_BACKEND:$IMAGE_TAG
            """
          }
        }
      }
    }

    stage('Frontend - Build & Push') {
      steps {
        dir('frontend') {
          container('docker') {
            sh """
              docker build -t $REGISTRY/$REPO_FRONTEND:$IMAGE_TAG .
              docker push $REGISTRY/$REPO_FRONTEND:$IMAGE_TAG
            """
          }
        }
      }
    }

    stage('Update k8s manifests repo') {
      steps {
        dir('k8s-yamls') {
          withCredentials([usernamePassword(credentialsId: 'github-creds', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
            sh """
              git config user.email "jenkins@ci.local"
              git config user.name "Jenkins CI"

              # Actualizar imágenes
              sed -i 's|clarozzz/k8s-backend:.*|clarozzz/k8s-backend:${IMAGE_TAG}|g' *.yaml
              sed -i 's|clarozzz/k8s-frontend:.*|clarozzz/k8s-frontend:${IMAGE_TAG}|g' *.yaml

              for file in *.yaml; do
                  if grep -q "argocd.argoproj.io/compare-options" "\$file"; then
                      # Si existe, la reemplazamos (asegurando la indentación)
                      sed -i "s|^\\(\\s*\\)argocd.argoproj.io/compare-options: .*|\\1argocd.argoproj.io/compare-options: IgnoreExtraneous|g" "\$file"
                  else
                      # Si NO existe, la agregamos *después* de la línea de Change Cause (aseguramos 4 espacios)
                      sed -i '/kubernetes.io\\/change-cause:/a\\    argocd.argoproj.io/compare-options: IgnoreExtraneous' "\$file"
                  fi
              done

              # Obtenemos el mensaje del commit desde la variable que asignamos en el stage Clone repositories
              COMMIT_MSG="${env.SAMPLE_COMMIT_MSG}"

              # Escapamos las comillas (") del mensaje para que no rompan la sintaxis de la anotación YAML.
              ESCAPED_COMMIT_MSG=\$(echo "\$COMMIT_MSG" | sed 's/"/\\"/g')
              
              # Asignamos el mensaje escapado a CHANGE_CAUSE y le agregamos la fecha
              DATE=\$(date '+%Y-%m-%d %H:%M:%S')
              CHANGE_CAUSE="\$ESCAPED_COMMIT_MSG on \$DATE"

              # Reemplazar la anotación en los YAML
              sed -i "s|kubernetes.io/change-cause: .*|kubernetes.io/change-cause: \\\"\$CHANGE_CAUSE\\\"|g" *.yaml

              git add .
              
              git commit -m "Src commit msg: ${env.SAMPLE_COMMIT_MSG}" || echo "No changes to commit"

              git remote set-url origin https://${GIT_USER}:${GIT_PASS}@github.com/CesarClaros49/k8s-manifests.git
              git push origin main
            """
          }
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        dir('k8s-yamls') {
          container('kubectl') {
              sh "kubectl apply -f backend.yaml -n default"
              sh "kubectl apply -f frontend.yaml -n default"
          }
        }
      }
    }

  }
}






