pipeline {
  agent {
    kubernetes {
      inheritFrom 'agente-prueba'
    }
  }

  environment {
    REGISTRY = 'clarozzz'
    REPO_BACKEND = 'k8s-backend'
    REPO_FRONTEND = 'k8s-frontend'
    IMAGE_TAG = "${env.BUILD_NUMBER}" // o usa `git rev-parse --short HEAD`
    YAML_REPO = 'https://github.com/CesarClaros49/k8s-manifests.git'
  }

  stages {

    stage('Clone repositories') {
      steps {
        script {
          git 'https://github.com/CesarClaros49/sample-docker'
          dir('k8s-yamls') {
            git branch: 'main', url: "${YAML_REPO}"
          }
        }
      }
    }

    stage('Login to DockerHub') {
      steps {
        container('docker') {
          withCredentials([usernamePassword(credentialsId: 'docker-hub-creds', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
            sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin'
          }
        }
      }
    }

    stage('Backend - Build & Push') {
      steps {
        dir('backend') {
          container('docker') {
            sh """
              docker build -t $REGISTRY/$REPO_BACKEND:$IMAGE_TAG .
              docker push $REGISTRY/$REPO_BACKEND:$IMAGE_TAG
            """
          }
        }
      }
    }

    stage('Frontend - Build & Push') {
      steps {
        dir('frontend') {
          container('docker') {
            sh """
              docker build -t $REGISTRY/$REPO_FRONTEND:$IMAGE_TAG .
              docker push $REGISTRY/$REPO_FRONTEND:$IMAGE_TAG
            """
          }
        }
      }
    }

stage('Update k8s manifests repo') {
  steps {
    dir('k8s-yamls') {
      withCredentials([usernamePassword(credentialsId: 'github-creds', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
sh '''
  git config user.email "jenkins@ci.local"
  git config user.name "Jenkins CI"

  # ðŸ”¹ Actualiza las imÃ¡genes
  sed -i 's|clarozzz/k8s-backend:.*|clarozzz/k8s-backend:${IMAGE_TAG}|g' *.yaml
  sed -i 's|clarozzz/k8s-frontend:.*|clarozzz/k8s-frontend:${IMAGE_TAG}|g' *.yaml

  # ðŸ”¹ Actualiza (o agrega) la anotaciÃ³n kubernetes.io/change-cause
  for f in *.yaml; do
    if grep -q "kubernetes.io/change-cause" "$f"; then
      sed -i "s|kubernetes.io/change-cause:.*|kubernetes.io/change-cause: Updated images to tag ${IMAGE_TAG} by Jenkins build #${BUILD_NUMBER}|g" "$f"
    elif grep -q "annotations:" "$f"; then
      sed -i "/annotations:/a\    kubernetes.io/change-cause: Updated images to tag ${IMAGE_TAG} by Jenkins build #${BUILD_NUMBER}" "$f"
    else
      sed -i "/metadata:/a\  annotations:\\n    kubernetes.io/change-cause: Updated images to tag ${IMAGE_TAG} by Jenkins build #${BUILD_NUMBER}" "$f"
    fi
  done

  git add .
  git commit -m "Update images and change-cause to tag ${IMAGE_TAG}" || echo "No changes to commit"

  git remote set-url origin https://${GIT_USER}:${GIT_PASS}@github.com/CesarClaros49/k8s-manifests.git
  git push origin main
'''

      }
    }
  }
}



  }
}









